<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.job.dashboard.domain.personal.PersonalDashMapper">

    <select id="profileCheck" parameterType="int" resultType="int">
        SELECT /*PersonalDashMapper.profileCheck*/
        count(*) AS countProfile
        FROM USER_PROFILE_INFO
        WHERE USER_NO = #{userNo}
    </select>

    <select id="getProfile" parameterType="int" resultType="com.job.dashboard.domain.dto.UserProfileInfoDTO">
        /*기존 프로필 가져오기*/
        SELECT /* PersonalDashMapper.getProfile */
            ui.email,
            ui.user_type_code,
            (SELECT detail_name FROM code_detail WHERE group_code = 'user_type' AND detail_code = ui.user_type_code) AS user_type_code_name,
            up.NAME,
            up.PHONE,
            up.BIRTH,
            up.GENDER,
            up.ZIPCODE,
            up.ADDRESS,
            up.ADDRESS_DETAIL,
            up.PART_TIME_EXPERIENCE
        FROM
            user_info ui
                LEFT JOIN USER_PROFILE_INFO up ON ui.USER_NO = up.USER_NO
        WHERE ui.USER_NO = #{userNo}
    </select>

    <select id="checkProfile" parameterType="int" resultType="com.job.dashboard.domain.dto.UserProfileInfoDTO">
        /* PersonalDashMapper.checkProfile */
        SELECT PROFILE_ID,
               USER_NO,
               NAME,
               PHONE,
               BIRTH,
               GENDER,
               ZIPCODE,
               ADDRESS,
               ADDRESS_DETAIL,
               PART_TIME_EXPERIENCE,
               SYSTEM_REGISTER_ID,
               SYSTEM_REGISTER_DATETIME,
               SYSTEM_UPDATER_ID,
               SYSTEM_UPDATE_DATETIME
        FROM USER_PROFILE_INFO
        WHERE USER_NO = #{userNo}
    </select>

    <select id="getProfileIdSeq" parameterType="int" resultType="int">
        /* PersonalDashMapper.getProfileIdSeq */
        SELECT COALESCE(MAX(PROFILE_ID) + 1, 1) as profile_id_seq
        FROM USER_PROFILE_INFO
    </select>

    <insert id="saveProfile" parameterType="com.job.dashboard.domain.dto.UserProfileInfoDTO" >
        /* PersonalDashMapper.saveProfile */
        INSERT INTO USER_PROFILE_INFO
        (
            PROFILE_ID,
            USER_NO,
            NAME,
            PHONE,
            BIRTH,
            GENDER,
            ZIPCODE,
            ADDRESS,
            ADDRESS_DETAIL,
            PART_TIME_EXPERIENCE,
            SYSTEM_REGISTER_DATETIME,
            SYSTEM_REGISTER_ID,
            SYSTEM_UPDATE_DATETIME,
            SYSTEM_UPDATER_ID
        ) VALUES (
            #{profileId},
            #{userNo},
            #{name},
            #{phone},
            #{birth},
            #{gender},
            #{zipcode},
            #{address},
            #{addressDetail},
            #{partTimeExperience},
            #{systemRegisterDatetime},
            #{userNo},
            #{systemUpdateDatetime},
            #{userNo}
        ) ON DUPLICATE KEY UPDATE
            NAME                   = #{name},
            PHONE                  = #{phone},
            BIRTH                  = #{birth},
            GENDER                 = #{gender},
            ZIPCODE                = #{zipcode},
            ADDRESS                = #{address},
            ADDRESS_DETAIL         = #{addressDetail},
            PART_TIME_EXPERIENCE   = #{partTimeExperience},
            SYSTEM_UPDATE_DATETIME = #{systemUpdateDatetime},
            SYSTEM_UPDATER_ID      = #{userNo}
    </insert>

    <select id="getOldPassword" parameterType="int" resultType="com.job.dashboard.domain.dto.UserDTO">
        SELECT   /* PersonalDashMapper.getOldPassword */ password
        FROM user_info
        WHERE USER_NO = #{userNo}
    </select>

    <update id="updatePassword" parameterType="com.job.dashboard.domain.dto.UserDTO">
        /* PersonalDashMapper.updatePassword */
        UPDATE user_info
        SET
            PASSWORD = #{password},
            SYSTEM_UPDATER_ID = #{userNo},
            SYSTEM_UPDATE_DATETIME = now()
        WHERE
            USER_NO = #{userNo}
    </update>

    <select id="applyStatusList" parameterType="map" resultType="com.job.dashboard.domain.dto.JobApplicationDTO">
        SELECT /* PersonalDashMapper.applyList */
            jai.application_id,
            jai.job_id,
            jai.USER_NO,
            jai.status_type_code,
            (SELECT detail_name FROM code_detail WHERE group_code = 'status_type' AND detail_code = jai.status_type_code) AS status_type_code_name,
            DATE_FORMAT(jai.system_register_datetime, '%Y-%m-%d') AS system_register_datetime,
            jpi.title,
            jpi.zipcode,
            jpi.address,
            jpi.address_detail,
            jpi.salary
        FROM
            job_application_info jai
                INNER JOIN job_post_info jpi ON jai.job_id = jpi.job_id
        WHERE jai.USER_NO = #{userNo}
          AND jpi.title LIKE CONCAT('%', #{keyword}, '%')
        ORDER BY jai.system_register_datetime DESC
    </select>


    <update id="applyListCancel" parameterType="int">
        /* PersonalDashMapper.applyListCancel*/
        UPDATE job_application_info
        SET
            STATUS_TYPE_CODE = '지원취소'
        WHERE
            APPLICATION_ID = #{applicationId}
    </update>

    <select id="applyJobList" parameterType="map" resultType="com.job.dashboard.domain.dto.JobApplicationDTO">
        SELECT /* PersonalDashMapper.getApplyJobList*/
            jpi.title,
            jpi.job_type_code,
            (SELECT detail_name FROM code_detail WHERE group_code = 'job_type' AND detail_code = jpi.job_type_code) AS job_type_code_name,
            jpi.address,
            jpi.address_detail,
            jpi.salary,
            jpi.salary_type_code,
            (SELECT detail_name FROM code_detail WHERE group_code = 'salary_type' AND detail_code = jpi.salary_type_code) AS salary_type_code_name,
            jpi.salary,
            jpi.job_time,
            jpi.status_type_code,
            (SELECT detail_name FROM code_detail WHERE group_code = 'status_type' AND detail_code = jpi.status_type_code) AS status_type_code_name,
            jai.application_id,
            jai.job_id,
            DATE_FORMAT(jai.system_register_datetime, '%Y-%m-%d') AS system_register_datetime
        FROM job_application_info jai
        INNER JOIN job_post_info jpi ON jai.job_id = jpi.job_id
        WHERE jai.USER_NO = #{userNo}
        AND jpi.title LIKE CONCAT('%', #{keyword}, '%')
        ORDER BY jai.system_register_datetime DESC
    </select>

    <select id="getCountJobs" resultType="int">
        SELECT COUNT(*) FROM job_post_info
    </select>
</mapper>