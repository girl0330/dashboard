<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.job.dashboard.domain.business.BusinessDashMapper">
    <select id="checkBusinessProfile" parameterType="int" resultType="com.job.dashboard.domain.dto.CompanyInfoDTO">
        /* BusinessDashMapper.checkBusinessProfile */
        SELECT COMPANY_ID,
               USER_NO,
               COMPANY_NAME,
               COMPANY_DESCRIPTION,
               ADDRESS,
               INDUSTRY_CODE,
               BUSINESS_TYPE_CODE,
               BUSINESS_NUMBER,
               SYSTEM_REGISTER_ID,
               SYSTEM_UPDATER_ID
        FROM COMPANY_INFO
        WHERE USER_NO = #{userNo}
    </select>

    <select id="getCompanyIdSeq" parameterType="int" resultType="int">
        /* BusinessDashMapper.getCompanyIdSeq */
        SELECT COALESCE(MAX(COMPANY_ID) + 1, 1) as company_id_seq
        FROM COMPANY_INFO
    </select>

    <insert id="saveBusinessProfile" parameterType="com.job.dashboard.domain.dto.CompanyInfoDTO" >
        /* BusinessDashMapper.saveBusinessProfile */
        INSERT INTO company_info
        (COMPANY_ID,
            USER_NO,
            COMPANY_NAME,
            COMPANY_DESCRIPTION,
            ADDRESS,
            INDUSTRY_CODE,
            BUSINESS_TYPE_CODE,
            BUSINESS_NUMBER,
            SYSTEM_REGISTER_ID,
            SYSTEM_UPDATER_ID
        ) VALUES (
                     #{companyId},
                     #{userNo},
                     #{companyName},
                     #{companyDescription},
                     #{address},
                     #{industryCode},
                     #{businessTypeCode},
                     #{businessNumber},
                     #{userNo},
                     #{userNo}
                 ) ON DUPLICATE KEY UPDATE
            USER_NO             = #{userNo},
            COMPANY_NAME        = #{companyName},
            COMPANY_DESCRIPTION = #{companyDescription},
            ADDRESS             = #{address},
            INDUSTRY_CODE       = #{industryCode},
            BUSINESS_TYPE_CODE  = #{businessTypeCode},
            BUSINESS_NUMBER     = #{businessNumber},
            SYSTEM_UPDATER_ID   = #{userNo}
    </insert>

    <select id="getBusinessProfile" parameterType="int" resultType="com.job.dashboard.domain.dto.CompanyInfoDTO">
        /* BusinessDashMapper.getBusinessProfile */
        SELECT COMPANY_ID,
               USER_NO,
               COMPANY_NAME,
               COMPANY_DESCRIPTION,
               ADDRESS,
               INDUSTRY_CODE,
               BUSINESS_TYPE_CODE,
               BUSINESS_NUMBER,
               SYSTEM_REGISTER_ID,
               SYSTEM_UPDATER_ID
        FROM COMPANY_INFO
        WHERE USER_NO = #{userNo}
    </select>

    <select id="getOldPassword" parameterType="int" resultType="com.job.dashboard.domain.dto.CompanyInfoDTO">
        /* BusinessDashMapper.getOldPassword */
        SELECT password
        FROM user_info
        WHERE USER_NO = #{userNo}
    </select>

    <select id="postJobList" parameterType="int" resultType="com.job.dashboard.domain.dto.JobPostDTO">
        /* BusinessDashMapper.postJobList */
        SELECT
            job_id,
               title,
               job_type_code,
               (SELECT detail_name FROM code_detail WHERE group_code = 'job_type' AND detail_code = job_type_code) AS job_type_code_name,
               address,
               salary_type_code,
               (SELECT detail_name FROM code_detail WHERE group_code = 'salary_type' AND detail_code = salary_type_code) AS salary_type_code_name,
               salary,
               job_time,
               job_day_type_code,
               (SELECT detail_name FROM code_detail WHERE group_code = ' job_day_type' AND detail_code = job_day_type_code) AS job_day_type_code_name,
               number_of_staff,
               employment_type_code,
               (SELECT detail_name FROM code_detail WHERE group_code = 'employment_type' AND detail_code = employment_type_code) AS employment_type_code_name,
               system_register_id,
               system_updater_id,
               DATE_FORMAT(system_register_datetime, '%Y-%m-%d') AS system_register_datetime,
               status_type_code,
               (SELECT detail_name FROM code_detail WHERE group_code = 'status_type' AND detail_code = status_type_code) AS status_type_code_name
        from job_post_info jpi
        WHERE USER_NO = #{userNo}
    </select>

    <select id="getApplicants" parameterType="int" resultType="com.job.dashboard.domain.dto.JobApplicationDTO">
        SELECT
            /* BusinessDashMapper.getApplicants */
            jai.application_id,
            jai.job_id,
            jai.USER_NO,
            jai.status_type_code,
            (SELECT detail_name FROM code_detail WHERE group_code = 'status_type' AND detail_code = jai.status_type_code) AS status_type_code_name,
            DATE_FORMAT(jai.system_register_datetime, '%Y-%m-%d') AS system_register_datetime,
            jai.motivation_description,
            jpi.title,
            upi.NAME
        FROM
            job_application_info jai
                INNER JOIN job_post_info jpi ON jai.job_id = jpi.job_id
        INNER JOIN user_profile_info upi ON jai.USER_NO = upi.USER_NO
        WHERE
            jai.job_id = #{jobId}
        ORDER BY jai.system_register_datetime DESC
    </select>

    <select id="getApplicantsInfo" resultType="com.job.dashboard.domain.dto.JobApplicationDTO" parameterType="int">
        SELECT jai.*
        FROM job_application_info jai
        WHERE jpi.job_id = #{jobId}
          AND jai.user_no = #{userNo}
    </select>

    <select id="getCandidateApplyDetail" parameterType="int" resultType="com.job.dashboard.domain.dto.JobApplicationDTO">
        SELECT
            jai.JOB_ID,
            jai.USER_NO,
            jai.MOTIVATION_DESCRIPTION,
            jai.SYSTEM_REGISTER_DATETIME,
            jai.status_type_code,
            (SELECT detail_name FROM code_detail WHERE group_code = 'status_type' AND detail_code = jai.status_type_code) AS status_type_code_name,
            upi.NAME,
            upi.PHONE,
            upi.BIRTH,
            upi.GENDER
        FROM
            job_application_info jai
                INNER JOIN user_profile_info upi ON
                jai.USER_NO = upi.USER_NO
        WHERE
            jai.USER_NO = #{userNo}
          AND jai.job_id = #{jobId}
    </select>

    <update id="applyCandidate" parameterType="com.job.dashboard.domain.dto.JobApplicationDTO">
        UPDATE job_application_info
        SET status_type_code = 'HIRED'
        WHERE USER_NO = #{userNo}
          AND job_id = #{jobId}
--             ON DUPLICATE KEY UPDATE
--             status_type_code = 'APPLIED'
    </update>

    <update id="applyCancelCandidate" parameterType="com.job.dashboard.domain.dto.JobApplicationDTO">
        UPDATE job_application_info
        SET status_type_code = 'APPLIED'
        WHERE USER_NO = #{userNo}
          AND job_id = #{jobId}
    </update>
</mapper>